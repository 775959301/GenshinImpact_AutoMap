# 原神自动地图（Genshin Impact Auto Map）
原神自动地图，基于原神小地图的自动标记资源地图

目前做成了原神的PC端悬浮窗地图工具……（但也实现了自动跟踪的功能）

链接：https://pan.xunlei.com/s/VMRzpFyq2hmpeYjTydWOos2mA1
提取码：4b3u

## 开发环境

Visual Studio 2017 

opencv4.5.0

控制台应用

在VS里配置好Opencv即可进行编译输出，所用资源文件均已上传。

由于使用的是opencv的dll，以及程序中封装了一张较大的地图图片，所以最后生成的程序大概有37MB，发布版解压缩大致有92MB，以至于无法上传至GitHub，有需要的可以自己手动编译，或者点击上方链接下载。

链接版本只经过简单测试，如有任何问题可以提交反馈。

## 工作原理与系统权限

本地图是通过调用Windows Api来对原神的游戏窗口进行截屏，然后对画面进行图像处理，对地图与世界地图进行匹配来实现的自动追踪。

通过Api来设置地图为顶层窗口，使其保持在原神游戏窗口的上方。

之后的开发中将会涉及到数据文件的保存与读取，目前会在Temp目录中建立名为GenshinImpactAutoMap的文件夹，并在该文件夹中建立数据存档。

如：`C:\Users\%USERNAME%\AppData\Local\Temp\GenshinImpactAutoMap`

日后可能会开发GPU加速图像处理的功能，需要使用GPU运算。

除此之外不存在其他系统资源的使用，也没有获取系统权限的需求。

## 运行画面

![运行画面](https://github.com/GengGode/GenshinImpact_AutoMap/blob/master/GenshinImpact_Map_Test_1/Img/Snipaste_2021-01-07_15-09-00.png)


### 自动跟踪与搜索神瞳

![自动跟踪](https://github.com/GengGode/GenshinImpact_AutoMap/blob/master/GenshinImpact_Map_Test_1/Img/2021-01-27%2000-27-55_5.gif)


![搜索神瞳](https://github.com/GengGode/GenshinImpact_AutoMap/blob/master/GenshinImpact_Map_Test_1/Img/2021-01-27%2000-27-55_3.gif)

## 目前实现

地图显示（平移、缩放）

中键移动窗口位置（有Bug，会闪）

左键双击右上角退出

双击开启自动追踪，悬浮窗会自动显示角色所在位置的地图，但是会很卡，很卡，很卡。。。

（测试版还有过一次吃掉12个G内存的壮举，不过已经修复了。）

检测游戏状态（游戏全屏下会失效，启动的过程中进入游戏，不然可能游戏跟悬浮窗都显示不出来）

可以添加标记（代码里）

通过游戏内小地图，自动识别角色所在位置

获得小地图上出现的神瞳

在某些情况下自动隐藏悬浮窗，如传送时，打开大地图时，释放大招时……

修复了悬浮窗自动复位时，键鼠焦点转移，导致弹出输入法的问题。

## 计划实现

缩放改为以指针为中心

添加标记改为自动

根据数据库显示周围资源分布

自动记忆神瞳是否收集，判断显示哪些神瞳没被发现

优化UI

## 更远的计划

利用MFC或者Qt重写一个窗口，不再使用OpenCV提供的窗口，以便实现不规则窗口和边缘半透明效果

根据另一个做的小地图自动识别来看，还得优化自动识别的速度

## 一些已知的问题

游戏全屏时，因为悬浮窗处于置顶状态，悬浮窗和原神会争抢顶层窗口的位置，以至于游戏来回全屏和最小化。

推测可能是原神的问题，在双屏幕时全屏原神，在另一个屏幕上鼠标点击，原神就会最小化，然而B服原神不会。

经测试B服可以在全屏下使用，官服不行（令人迷惑.jpg）。

中键拖动窗口会闪烁，这个是由于OpenCV的鼠标回调返回的鼠标位置是基于窗口左上角的，拖动的话，在窗口移动时，鼠标的坐标是不变的，有点难以处理，用MFC或者Qt重写了可能会好些吧。
